<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>极简Markdown阅读器</title>
    <style>
        /* 基础变量：亮色主题 */
        :root {
            --bg-primary: #ffffff;
            --text-primary: #2d3748;
            --bg-secondary: #f7fafc;
            --border-color: #e2e8f0;
            --progress-bg: #edf2f7;
            --progress-fill: #4299e1;
            --font-size: 16px;
            --header-height: 50px;
            --footer-height: 50px;
            --transition: 0.3s ease;
        }

        /* 暗色主题变量 */
        [data-theme="dark"] {
            --bg-primary: #1a202c;
            --text-primary: #e2e8f0;
            --bg-secondary: #2d3748;
            --border-color: #4a5568;
            --progress-bg: #2d3748;
            --progress-fill: #63b3ed;
        }

        /* 全局重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            font-size: var(--font-size);
            line-height: 1.75;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: var(--header-height);
            padding-bottom: var(--footer-height);
        }

        /* 顶栏样式 */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-height);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
            transition: transform var(--transition);
        }

        .header.hidden {
            transform: translateY(-100%); /* 向上隐藏 */
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
        }

        .control-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
        }

        /* 进度条 */
        .progress-container {
            position: fixed;
            top: var(--header-height);
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--progress-bg);
            z-index: 99;
        }

        .progress-bar {
            height: 100%;
            background: var(--progress-fill);
            width: 0%;
            transition: width 0.1s linear;
        }

        /* 内容区 */
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* 移动端流畅滚动 */
        }

        /* Markdown样式优化 */
        .content h1 { font-size: 1.5rem; margin: 1.5rem 0 1rem; }
        .content h2 { font-size: 1.3rem; margin: 1.2rem 0 0.8rem; }
        .content p { margin-bottom: 1rem; }
        .content code { background: var(--bg-secondary); padding: 2px 4px; border-radius: 4px; }
        .content pre { background: var(--bg-secondary); padding: 1rem; border-radius: 8px; overflow-x: auto; }
        .content blockquote { border-left: 4px solid var(--progress-fill); padding-left: 1rem; margin: 1rem 0; opacity: 0.8; }
        .content ul, .content ol { margin: 1rem 0; padding-left: 2rem; }
        .content li { margin-bottom: 0.5rem; }
        .content strong { font-weight: 600; }
        .content em { font-style: italic; }
        .content u { text-decoration: underline; }
        .content del { text-decoration: line-through; }

        /* 底栏 */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--footer-height);
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: transform var(--transition);
        }

        .footer.hidden {
            transform: translateY(100%); /* 向下隐藏 */
        }

        /* 字体滑块 */
        .font-slider {
            width: 100px;
            -webkit-appearance: none;
            background: var(--border-color);
            border-radius: 5px;
            outline: none;
        }

        .font-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--progress-fill);
            border-radius: 50%;
            cursor: pointer;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .header { padding: 0 15px; }
            .content { padding: 15px; }
            .font-slider { width: 80px; }
        }

        @media (max-width: 480px) {
            .header-title { font-size: 16px; }
            .control-btn { font-size: 16px; }
        }
    </style>
</head>
<body>
    <!-- 顶栏 -->
    <header class="header">
        <div class="header-title">阅读器</div>
        <div class="header-controls">
            <button class="control-btn" id="themeToggle" title="切换主题">🌙</button>
            <input type="range" class="font-slider" id="fontSizeSlider" min="12" max="24" value="16" title="调整字体">
        </div>
    </header>

    <!-- 进度条 -->
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <!-- 内容区 -->
    <main class="content" id="content"></main>

    <!-- 底栏（仅作占位，可留空） -->
    <footer class="footer hidden"></footer>

    <script>
        // 内联Markdown解析器 - 避免外部文件加载问题
        class CustomMarkdownParser {
            constructor() {
                this.regexCache = {
                    escape: /\\([\\*_~#+\-])/g,
                    bold: /\*\*([^*]+?)\*\*/g,
                    italic: /\*([^*]+?)\*/g,
                    boldItalic: /\*\*\*([^*]+?)\*\*\*/g,
                    underline: /_([^_]+?)_/g,
                    strikethrough: /-([^-]+?)-/g,
                    heading: /^(#{1,6})\s+(.+)$/gm,
                    blockquote: /^(>+)\s+(.+)$/gm,
                    unorderedList: /^(\++)\s+(.+)$/gm,
                    orderedList: /^(\d+\.)\s+(.+)$/gm,
                    inlineCode: /~([^~]+?)~/g,
                    codeBlock: /~~~([\s\S]*?)~~~/g,
                    colorTag: /<([a-z0-9#]+)>([\s\S]*?)<\/\1>/gi,
                    link: /\[([^\]]+)\]\(([^)]+)\)/g,
                    image: /!\[([^\]]+)\]\(([^)]+)\)/g
                };
            }

            parse(markdown) {
                if (!markdown) return '';
                
                // 1. 首先处理转义字符
                let parsed = this.parseEscapes(markdown);
                
                // 2. 处理代码块（避免解析其中的内容）
                parsed = this.parseCodeBlocks(parsed);
                
                // 3. 处理块级元素
                parsed = this.parseBlockElements(parsed);
                
                // 4. 处理行内元素
                parsed = this.parseInlineElements(parsed);
                
                return parsed;
            }

            parseEscapes(input) {
                return input.replace(this.regexCache.escape, (match, char) => {
                    return char;
                });
            }

            parseCodeBlocks(input) {
                return input.replace(this.regexCache.codeBlock, (match, code) => {
                    return `<pre><code>${this.escapeHtml(code.trim())}</code></pre>`;
                });
            }

            parseBlockElements(input) {
                const lines = input.split('\n');
                let output = [];
                let inList = false;
                let listDepth = 0;
                let listType = ''; // 'ul' or 'ol'
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // 处理空行
                    if (line === '') {
                        if (inList) {
                            // 结束当前列表
                            while (listDepth > 0) {
                                output.push('</li></ul>');
                                listDepth--;
                            }
                            inList = false;
                            listType = '';
                        }
                        output.push('');
                        continue;
                    }
                    
                    // 处理标题
                    const headingMatch = line.match(this.regexCache.heading);
                    if (headingMatch) {
                        if (inList) {
                            while (listDepth > 0) {
                                output.push('</li></ul>');
                                listDepth--;
                            }
                            inList = false;
                            listType = '';
                        }
                        const level = headingMatch[1].length;
                        const text = headingMatch[2];
                        output.push(`<h${level}>${text}</h${level}>`);
                        continue;
                    }
                    
                    // 处理引用
                    const blockquoteMatch = line.match(this.regexCache.blockquote);
                    if (blockquoteMatch) {
                        if (inList) {
                            while (listDepth > 0) {
                                output.push('</li></ul>');
                                listDepth--;
                            }
                            inList = false;
                            listType = '';
                        }
                        const content = blockquoteMatch[2];
                        output.push(`<blockquote>${content}</blockquote>`);
                        continue;
                    }
                    
                    // 处理无序列表
                    const ulMatch = line.match(this.regexCache.unorderedList);
                    if (ulMatch) {
                        const depth = ulMatch[1].length;
                        const content = ulMatch[2];
                        
                        if (!inList || listType !== 'ul') {
                            if (inList) {
                                while (listDepth > 0) {
                                    output.push('</li></ul>');
                                    listDepth--;
                                }
                            }
                            output.push('<ul>');
                            inList = true;
                            listType = 'ul';
                            listDepth = 0;
                        }
                        
                        // 处理嵌套
                        if (depth > listDepth) {
                            output.push('<li><ul>');
                            listDepth = depth;
                        } else if (depth < listDepth) {
                            output.push('</ul></li>');
                            listDepth = depth;
                        } else if (i > 0 && ulMatch) {
                            output.push('</li>');
                        }
                        
                        output.push(`<li>${content}`);
                        continue;
                    }
                    
                    // 处理有序列表
                    const olMatch = line.match(this.regexCache.orderedList);
                    if (olMatch) {
                        const content = olMatch[2];
                        
                        if (!inList || listType !== 'ol') {
                            if (inList) {
                                while (listDepth > 0) {
                                    output.push('</li></ol>');
                                    listDepth--;
                                }
                            }
                            output.push('<ol>');
                            inList = true;
                            listType = 'ol';
                            listDepth = 1;
                        } else {
                            output.push('</li>');
                        }
                        
                        output.push(`<li>${content}`);
                        continue;
                    }
                    
                    // 普通段落
                    if (inList) {
                        while (listDepth > 0) {
                            output.push('</li></' + (listType === 'ul' ? 'ul' : 'ol') + '>');
                            listDepth--;
                        }
                        inList = false;
                        listType = '';
                    }
                    
                    output.push(`<p>${line}</p>`);
                }
                
                // 处理文档末尾的列表
                if (inList) {
                    while (listDepth >= 0) {
                        output.push('</li>');
                        if (listDepth > 0) {
                            output.push('</' + (listType === 'ul' ? 'ul' : 'ol') + '>');
                        }
                        listDepth--;
                    }
                }
                
                return output.join('\n');
            }

            parseInlineElements(input) {
                let parsed = input;
                
                // 按优先级顺序处理
                parsed = this.parseBold(parsed);
                parsed = this.parseItalic(parsed);
                parsed = this.parseBoldItalic(parsed);
                parsed = this.parseUnderline(parsed);
                parsed = this.parseStrikethrough(parsed);
                parsed = this.parseInlineCode(parsed);
                parsed = this.parseColorTags(parsed);
                parsed = this.parseLinks(parsed);
                parsed = this.parseImages(parsed);
                
                return parsed;
            }

            parseBold(text) {
                return text.replace(this.regexCache.bold, '<strong>$1</strong>');
            }

            parseItalic(text) {
                return text.replace(this.regexCache.italic, '<em>$1</em>');
            }

            parseBoldItalic(text) {
                return text.replace(this.regexCache.boldItalic, '<strong><em>$1</em></strong>');
            }

            parseUnderline(text) {
                return text.replace(this.regexCache.underline, '<u>$1</u>');
            }

            parseStrikethrough(text) {
                return text.replace(this.regexCache.strikethrough, '<del>$1</del>');
            }

            parseInlineCode(text) {
                return text.replace(this.regexCache.inlineCode, '<code>$1</code>');
            }

            parseColorTags(text) {
                return text.replace(this.regexCache.colorTag, (match, color, content) => {
                    const normalizedColor = color.toLowerCase();
                    let cssColor = normalizedColor;
                    
                    if (/^#[0-9a-f]{6}$/i.test(normalizedColor)) {
                        cssColor = normalizedColor;
                    } else {
                        const colorMap = {
                            red: '#FF0000', green: '#00FF00', blue: '#0000FF',
                            yellow: '#FFFF00', purple: '#800080', cyan: '#00FFFF',
                            magenta: '#FF00FF', orange: '#FFA500', pink: '#FFC0CB',
                            brown: '#A52A2A', black: '#000000', white: '#FFFFFF',
                            gray: '#808080', grey: '#808080'
                        };
                        cssColor = colorMap[normalizedColor] || '#000000';
                    }
                    
                    return `<span style="color: ${cssColor}">${content}</span>`;
                });
            }

            parseLinks(text) {
                return text.replace(this.regexCache.link, '<a href="$2" target="_blank" rel="noopener">$1</a>');
            }

            parseImages(text) {
                return text.replace(this.regexCache.image, '<img src="$2" alt="$1" style="max-width: 100%;">');
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // ---------------------- 核心状态管理 ----------------------
        const state = {
            theme: localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'),
            fontSize: localStorage.getItem('fontSize') || '16',
            isScrolling: false,
            hideTimeout: null
        };

        // ---------------------- DOM元素缓存 ----------------------
        const el = {
            body: document.body,
            header: document.querySelector('.header'),
            footer: document.querySelector('.footer'),
            content: document.getElementById('content'),
            progressBar: document.getElementById('progressBar'),
            themeToggle: document.getElementById('themeToggle'),
            fontSizeSlider: document.getElementById('fontSizeSlider')
        };

        // ---------------------- 初始化应用 ----------------------
        function init() {
            applyTheme(state.theme);
            applyFontSize(state.fontSize);
            loadMarkdown();
            bindEvents();
        }

        // ---------------------- 主题控制 ----------------------
        function applyTheme(theme) {
            el.body.setAttribute('data-theme', theme);
            el.themeToggle.textContent = theme === 'dark' ? '☀️' : '🌙';
        }

        // ---------------------- 字体控制 ----------------------
        function applyFontSize(size) {
            document.documentElement.style.setProperty('--font-size', `${size}px`);
            el.fontSizeSlider.value = size;
        }

        // ---------------------- 加载Markdown内容 ----------------------
        async function loadMarkdown() {
            try {
                // 使用示例Markdown内容，避免文件加载问题
                const exampleMarkdown = `# Markdown阅读器示例

这是一个**Markdown阅读器**的演示。

## 功能特性

* 支持*斜体*、**加粗**、***加粗斜体***
* 支持_下划线_和-删除线-
* 支持代码高亮：\`console.log("Hello")\`
* 支持颜色标签：<red>红色文本</red> <#00FF00>绿色文本</#00FF00>

## 代码块示例

~~~javascript
function hello() {
    console.log("Hello, Markdown!");
    return true;
}
~~~

## 列表示例

+ 无序列表项1
+ 无序列表项2
++ 嵌套列表项2.1
++ 嵌套列表项2.2
+ 无序列表项3

1. 有序列表项1
2. 有序列表项2
   1. 嵌套有序列表2.1
   2. 嵌套有序列表2.2
3. 有序列表项3

> 这是一个引用块
> 可以有多行内容

[点击这里访问示例网站](https://example.com)`;

                const parser = new CustomMarkdownParser();
                el.content.innerHTML = parser.parse(exampleMarkdown);
                
                // 如果确实需要从文件加载，可以取消注释以下代码
                /*
                const res = await fetch('./mtp/txt/gg1.txt');
                if (!res.ok) throw new Error(`加载失败：${res.status}`);
                const mdText = await res.text();
                el.content.innerHTML = parser.parse(mdText);
                */
            } catch (err) {
                console.error('加载Markdown失败:', err);
                el.content.innerHTML = `<p style="color: red;">内容加载失败：${err.message}</p>`;
            }
        }

        // ---------------------- 事件绑定 ----------------------
        function bindEvents() {
            // 1. 主题切换
            el.themeToggle.addEventListener('click', () => {
                state.theme = state.theme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', state.theme);
                applyTheme(state.theme);
            });

            // 2. 字体大小调整
            el.fontSizeSlider.addEventListener('input', (e) => {
                state.fontSize = e.target.value;
                localStorage.setItem('fontSize', state.fontSize);
                applyFontSize(state.fontSize);
            });

            // 3. 滚动事件（进度条+控制栏隐藏）
            window.addEventListener('scroll', handleScroll);

            // 4. 点击屏幕显示控制栏
            el.body.addEventListener('click', handleBodyClick);
        }

        // ---------------------- 处理滚动 ----------------------
        function handleScroll() {
            const scrollTop = window.pageYOffset;
            const scrollHeight = document.documentElement.scrollHeight;
            const clientHeight = document.documentElement.clientHeight;

            // 更新进度条
            const progress = (scrollTop / (scrollHeight - clientHeight)) * 100;
            el.progressBar.style.width = `${Math.min(progress, 100)}%`;

            // 控制顶栏/底栏隐藏（滑动超过10px隐藏）
            if (scrollTop > 10) {
                el.header.classList.add('hidden');
                el.footer.classList.add('hidden');
                state.isScrolling = true;
            } else {
                el.header.classList.remove('hidden');
                state.isScrolling = false;
            }
        }

        // ---------------------- 处理点击屏幕 ----------------------
        function handleBodyClick() {
            // 显示控制栏
            el.header.classList.remove('hidden');
            el.footer.classList.remove('hidden');

            // 清除之前的定时器
            if (state.hideTimeout) clearTimeout(state.hideTimeout);

            // 2秒后自动隐藏（无操作时）
            state.hideTimeout = setTimeout(() => {
                if (!state.isScrolling) {
                    el.header.classList.add('hidden');
                    el.footer.classList.add('hidden');
                }
            }, 2000);
        }

        // 启动应用
        init();
    </script>
</body>
</html>
