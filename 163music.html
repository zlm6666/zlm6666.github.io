<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网易云音乐解析 - get163music.netlify.app</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- APlayer CSS -->
    <link rel="stylesheet" href="./mtp/Aplayer/APlayer.min.css">
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #00cec9;
            --dark-color: #2d3436;
            --light-color: #dfe6e9;
        }
        
        body {
            font-family: 'Poppins', 'Noto Sans SC', sans-serif;
            background-color: #f8f9fa;
            color: var(--dark-color);
            min-height: 100vh;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #8257e6);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .nav-link {
            font-weight: 500;
            transition: all 0.3s ease;
            border-radius: 30px;
            padding: 8px 20px !important;
        }
        
        .nav-link.active, .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        .hero-section {
            padding: 100px 0 70px;
            background: linear-gradient(120deg, #f3f9ff, #e3f2fd);
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }
        
        .hero-section::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -10%;
            width: 50%;
            height: 200%;
            background: radial-gradient(circle, rgba(108, 92, 231, 0.08) 0%, transparent 70%);
            transform: rotate(45deg);
            z-index: 0;
        }
        
        .hero-title {
            font-weight: 800;
            font-size: 3rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary-color), #8257e6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 12px rgba(108, 92, 231, 0.15);
        }
        
        .hero-subtitle {
            font-size: 1.2rem;
            color: #5a5a7a;
            max-width: 700px;
            margin: 0 auto 30px;
        }
        
        .card {
            border-radius: 16px;
            border: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
            margin-bottom: 25px;
            background: white;
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background: white;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            font-size: 1.2rem;
            padding: 20px 25px;
            color: var(--primary-color);
        }
        
        .card-body {
            padding: 25px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #8257e6);
            border: none;
            padding: 10px 30px;
            font-weight: 500;
            border-radius: 50px;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 18px rgba(108, 92, 231, 0.4);
        }
        
        .form-control {
            border-radius: 12px;
            padding: 12px 20px;
            border: 1px solid #e1e5eb;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(108, 92, 231, 0.25);
        }
        
        .search-results {
            margin-top: 20px;
        }
        
        .song-card {
            background: white;
            border-radius: 14px;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 1px solid #edf2f7;
            transition: all 0.3s;
        }
        
        .song-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1);
        }
        
        .song-card-img {
            width: 100%;
            height: 140px;
            object-fit: cover;
        }
        
        .song-card-body {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .song-card-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            min-height: 52px;
        }
        
        .song-card-artist {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .song-card-footer {
            margin-top: auto;
        }
        
        .quality-option {
            padding: 10px 15px;
            margin: 5px;
            border-radius: 10px;
            background-color: #f1f3f9;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: inline-block;
        }
        
        .quality-option:hover {
            background-color: #e9ecef;
        }
        
        .quality-option.selected {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }
        
        .song-info {
            display: flex;
            gap: 25px;
            margin-bottom: 30px;
            align-items: center;
        }
        
        .album-cover {
            width: 180px;
            height: 180px;
            border-radius: 12px;
            object-fit: cover;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }
        
        .song-details {
            flex: 1;
        }
        
        .song-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .song-artist {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 25px;
        }
        
        .song-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .meta-item {
            background-color: #f8f9fc;
            padding: 12px 15px;
            border-radius: 12px;
            font-size: 0.95rem;
        }
        
        .download-btn {
            display: inline-flex;
            align-items: center;
            padding: 12px 25px;
            background: linear-gradient(135deg, #00b894, var(--secondary-color));
            color: white;
            text-decoration: none;
            font-weight: 500;
            border-radius: 50px;
            transition: all 0.3s;
            box-shadow: 0 5极 15px rgba(0, 206, 201, 0.3);
        }
        
        .download-btn:hover {
            transform: translateY(-3px);
            color: white;
            box-shadow: 0 7px 18px rgba(0, 206, 201, 0.4);
        }
        
        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f3f9;
        }
        
        .player-container {
            margin: 30px 0;
        }
        
        .aplayer {
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            font-family: inherit;
        }
        
        .lyrics-container {
            background: white;
            padding: 25px;
            border-radius: 14px;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.03);
            line-height: 1.8;
            position: relative;
        }
        
        .lyric-line {
            padding: 8px 0;
            transition: all 0.3s;
            position: relative;
            opacity: 0.7;
        }
        
        .lyric-line.active {
            color: var(--primary-color);
            font-weight: 600;
            transform: scale(1.05);
            opacity: 1;
        }
        
        .lyric-line::before {
            content: "";
            position: absolute;
            left: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background-color: var(--primary-color);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .lyric-line.active::before {
            opacity: 1;
        }
        
        footer {
            background: var(--dark-color);
            color: white;
            padding: 40px 0 30px;
            margin-top: 80px;
        }
        
        .footer-links a {
            color: var(--light-color);
            display: block;
            margin-bottom: 8px;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: var(--secondary-color);
        }
        
        .copyright {
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(108, 92, 231, 0.3);
            border-radius: 50%;
            border-top: 5px solid var(--primary-color);
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            font-size: 1.1rem;
            color: var(--dark-color);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            color: var(--dark-color);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            font-weight: 500;
            z-index: 10000;
            display: none;
            max-width: 400px;
            border-left: 5px solid var(--primary-color);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.4s ease;
        }
        
        .toast.error {
            border-left-color: #ff4757;
        }
        
        .toast.success {
            border-left-color: #00b894;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.2rem;
            }
            
            .song-info {
                flex-direction: column;
                text-align: center;
            }
            
            .album-cover {
                margin-bottom: 20px;
            }
            
            .song-card {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-music me-2"></i>网易云音乐解析
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-page="search">
                            <i class="fas fa-search me-1"></i>音乐搜索
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="parse">
                            <i class="fas fa-wand-magic-sparkles me-1"></i>快速解析
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="about">
                            <i class="fas fa-info-circle me-1"></i>关于我们
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 搜索页面 -->
    <div id="search-page" class="page active">
        <section class="hero-section">
            <div class="container text-center">
                <h1 class="hero-title">探索网易云海量音乐</h1>
                <p class="hero-subtitle">通过我们强大的搜索引擎，发掘您喜爱的音乐作品，体验无损音质和独特音乐魅力</p>
            </div>
        </section>

        <section class="container my-5">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-search me-2"></i>音乐搜索
                </div>
                <div class="card-body">
                    <div class="input-group mb-4">
                        <input type="text" class="form-control" id="searchInput" placeholder="输入歌曲名称、歌手或专辑...">
                        <button class="btn btn-primary" type="button" id="searchBtn">
                            <i class="fas fa-search me-1"></i>搜索音乐
                        </button>
                    </div>
                    
                    <div class="loading-overlay" id="searchLoading">
                        <div class="spinner"></div>
                        <p class="loading-text">正在搜索音乐，请稍候...</p>
                    </div>
                    
                    <div id="searchResults" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mt-4">
                        <!-- 搜索结果会动态加载到这里 -->
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- 解析页面 -->
    <div id="parse-page" class="page">
        <section class="hero-section">
            <div class="container text-center">
                <h1 class="hero-title">轻松解析网易云音乐</h1>
                <p class="hero-subtitle">通过ID或分享链接一键获取无损音质音乐，享受顶级音质体验</p>
            </div>
        </section>

        <section class="container my-5">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-wand-magic-sparkles me-2"></i>快速解析
                </div>
                <div class="card-body">
                    <div class="input-group mb-4">
                        <input type="text" class="form-control" id="parseInput" placeholder="输入歌曲ID或网易云音乐分享链接...">
                        <button class="btn btn-primary" type="button" id="parseBtn">
                            <i class="fas fa-bolt me-1"></i>立即解析
                        </button>
                    </div>
                    
                    <div>
                        <p class="mb-3"><i class="fas fa-headphones me-2"></i>选择音质：</p>
                        <div class="d-flex flex-wrap justify-content-center">
                            <div class="quality-option selected" data-value="standard">标准音质</div>
                            <div class="quality-option" data-value="exhigh">极高音质</div>
                            <div class="quality-option" data-value="lossless">无损音质</div>
                            <div class="quality-option" data-value="hires">Hi-Res音质</div>
                            <div class="quality-option" data-value="jyeffect">高清环绕声</div>
                            <div class="quality-option" data-value="sky">沉浸环绕声</div>
                            <div class="quality-option" data-value="jymaster">超清母带</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="song-detail-container" id="parseResultArea" style="display: none;">
                <div class="song-info">
                    
                    <div class="song-details">
                        <h2 class="song-title" id="songName">歌曲名称</h2>
                        <p class="song-artist" id="artistName">歌手名称</p>
                        
                        <div class="song-meta">
                            <div class="meta-item">
                                <i class="fas fa-compact-disc"></i>
                                <span>专辑：<span id="albumName">未知专辑</span></span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-volume-up"></i>
                                <span>音质：<span id="qualityDisplay">标准音质</span></span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-weight-hanging"></i>
                                <span>大小：<span id="fileSize">0 MB</span></span>
                            </div>
                            <!-- 时长显示 - 只在有数据时显示 -->
                            <div class="meta-item" id="durationItem" style="display: none;">
                                <i class="fas fa-clock"></i>
                                <span>时长：<span id="songDuration">0:00</span></span>
                            </div>
                        </div>
                        
                        <a href="#" id="downloadBtn" class="download-btn">
                            <i class="fas fa-download me-1"></i>下载音乐
                        </a>
                    </div>
                </div>
                
                <div class="player-container">
                    <div id="aplayer"></div>
                </div>
                
                <h5 class="section-title"><i class="fas fa-file-alt me-2"></i>歌词</h5>
                <div class="lyrics-container" id="lyricsContainer">
                    <p>加载音乐后显示歌词</p>
                </div>
            </div>
        </section>
    </div>

    <!-- 关于页面 -->
    <div id="about-page" class="page">
        <section class="hero-section">
            <div class="container text-center">
                <h1 class="hero-title">关于网易云音乐解析</h1>
                <p class="hero-subtitle">了解我们的使命、技术原理和服务条款</p>
            </div>
        </section>

        <section class="container my-5">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-info-circle me-2"></i>关于我们
                </div>
                <div class="card-body">
                    <h4>我们的使命</h4>
                    <p>网易云音乐解析项目致力于为音乐爱好者提供便捷的无损音乐获取方式，打破平台界限，让音乐自由流动。</p>
                    
                    <h4 class="mt-4">技术原理</h4>
                    <p>通过看戏仔API获取音乐元数据，结合高级音质解析技术实现高质量音乐获取。</p>
                    
                    <h4 class="mt-4">服务声明</h4>
                    <p>本项目仅供学习研究使用，请严格遵守相关版权规定。在使用音乐内容24小时后请主动删除。</p>
                    
                    <h4 class="mt-4">作者想说</h4>
                    <p>因为布局文件都是AI写的，还有这些介绍也是，所以可能会存在瞎写的情况，不必理会</p>
                </div>
            </div>
        </section>
    </div>

    <!-- 页脚 -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-4 mb-md-0">
                    <h5 class="text-white mb-4"><i class="fas fa-music me-2"></i>网易云音乐解析</h5>
                    <p class="text-light">为音乐爱好者提供便捷的无损音乐解析服务</p>
                </div>
                
                <div class="col-md-2 col-6">
                    <h5 class="text-white mb-4">快速链接</h5>
                    <div class="footer-links">
                        <a href="#" class="nav-link-page" data-page="search"><i class="fas fa-search me-2"></i>音乐搜索</a>
                        <a href="#" class="nav-link-page" data-page="parse"><i class="fas fa-wand-magic-sparkles me-2"></i>快速解析</a>
                        <a href="#" class="nav-link-page" data-page="about"><i class="fas fa-info-circle me-2"></i>关于我们</a>
                    </div>
                </div>
                
                <div class="col-md-2 col-6">
                    <h5 class="text-white mb-4">使用帮助</h5>
                    <div class="footer-links">
                        <a href="#"><i class="fas fa-question-circle me-2"></i>使用教程</a>
                        <a href="#"><i class="fas fa-exclamation-triangle me-2"></i>常见问题</a>
                        <a href="#"><i class="fas fa-comments me-2"></i>联系我们</a>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <h5 class="text-white mb-4">关注我们</h5>
                    <div class="footer-links">
                        <a href="#"><i class="fab fa-github me-2"></i>GitHub</a>
                        <a href="#"><i class="fab fa-telegram me-2"></i>Telegram频道</a>
                        <a href="#"><i class="fab fa-twitter me-2"></i>Twitter</a>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <p class="text-center copyright mt-4">
                        &copy; 2025 网易云音乐解析 | 仅供学习使用 | 内容来源: 网易云音乐
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- 加载覆盖层 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p class="loading-text">加载中，请稍候...</p>
    </div>

    <!-- Toast通知 -->
    <div class="toast" id="toast">操作成功！</div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- APlayer JS -->
    <script src="./mtp/Aplayer/APlayer.min.js"></script>
    <script>
        $(document).ready(function() {
            // 当前选中的音质
            let selectedQuality = 'standard';
            let ap = null; // 全局播放器实例
            
            // =============================
            // 页面初始化
            // =============================
            
            // 默认隐藏解析结果区域
            $('#parseResultArea').hide();
            
            // 页面切换功能
            $('.nav-link').click(function(e) {
                e.preventDefault();
                let page = $(this).data('page');
                
                // 更新导航栏状态
                $('.nav-link').removeClass('active');
                $(this).addClass('active');
                
                // 切换页面
                $('.page').removeClass('active');
                $('#' + page + '-page').addClass('active');
                
                // 滚动到顶部
                window.scrollTo(0, 0);
            });
            
            // 页脚链接点击事件
            $('.nav-link-page').click(function(e) {
                e.preventDefault();
                let page = $(this).data('page');
                
                // 更新导航栏状态
                $('.nav-link').removeClass('active');
                $('[data-page="' + page + '"]').addClass('active');
                
                // 切换页面
                $('.page').removeClass('active');
                $('#' + page + '-page').addClass('active');
                
                // 滚动到顶部
                window.scrollTo(0, 0);
            });
            
            // 音质选项点击事件
            $('.quality-option').click(function() {
                // 移除所有选中状态
                $('.quality-option').removeClass('selected');
                // 添加当前选中状态
                $(this).addClass('selected');
                // 更新选中的音质
                selectedQuality = $(this).data('value');
                // 更新显示
                $('#qualityDisplay').text(getQualityText(selectedQuality));
            });
            
            // =============================
            // 搜索功能实现
            // =============================
            
            // 搜索按钮点击事件
            $('#searchBtn').click(function() {
                let keyword = $('#searchInput').val().trim();
                if (!keyword) {
                    showToast('请输入歌曲名称', 'error');
                    return;
                }
                
                searchMusic(keyword);
            });
            
            // 搜索框回车事件
            $('#searchInput').keypress(function(e) {
                if (e.which === 13) {
                    $('#searchBtn').click();
                }
            });
            
            // 搜索音乐函数
            function searchMusic(keyword) {
                showLoading(true, 'searchLoading');
                $('#searchResults').empty();
                
                $.ajax({
                    url: 'https://api.kxzjoker.cn/api/163_search',
                    type: 'GET',
                    data: {
                        name: keyword,
                        limit: 12
                    },
                    dataType: 'json',
                    success: function(data) {
                        showLoading(false, 'searchLoading');
                        
                        if (!data || !data.data || data.data.length === 0) {
                            $('#searchResults').html(`
                                <div class="col-12 text-center py-5">
                                    <i class="fas fa-search mb-4" style="font-size: 3rem; opacity: 0.3;"></i>
                                    <h4 class="mb-3">未找到相关歌曲</h4>
                                    <p>请尝试其他关键词，或检查输入是否正确</p>
                                </div>
                            `);
                            return;
                        }
                        
                        // 显示搜索结果
                        let songs = data.data;
                        let html = '';
                        
                        songs.forEach(function(song, index) {
                            let songId = song.id;
                            let songName = song.name;
                            let artistName = Array.isArray(song.artists) ? 
                                song.artists.map(artist => artist.name).join(', ') : 
                                song.artists;
                            
                            let albumName = song.album ? song.album.name : '';
                            let albumCover = song.album && song.album.picUrl ? 
                                song.album.picUrl : 
                                'https://via.placeholder.com/300';
                            
                            // 构建卡片HTML
                            html += `
                                <div class="col">
                                    <div class="song-card">
                                        
                                        <div class="song-card-body">
                                            <h5 class="song-card-title">${songName}</h5>
                                            <p class="song-card-artist">${artistName}</p>
                                            <div class="song-card-footer">
                                                <button class="btn btn-sm btn-outline-primary copy-id-btn" data-id="${songId}">
                                                    <i class="fas fa-copy me-1"></i>复制ID
                                                </button>
                                                <button class="btn btn-sm btn-primary parse-btn" data-id="${songId}">
                                                    <i class="fas fa-link me-1"></i>解析
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        $('#searchResults').html(html);
                        
                        // 绑定复制按钮事件
                        $('.copy-id-btn').click(function() {
                            let id = $(this).data('id');
                            navigator.clipboard.writeText(id).then(() => {
                                showToast('ID已复制到剪贴板', 'success');
                            });
                        });
                        
                        // 绑定解析按钮事件
                        $('.parse-btn').click(function() {
                            let songId = $(this).data('id');
                            // 切换到解析页面
                            $('.nav-link').removeClass('active');
                            $('[data-page="parse"]').addClass('active');
                            $('.page').removeClass('active');
                            $('#parse-page').addClass('active');
                            
                            // 填充并解析
                            $('#parseInput').val(songId);
                            parseMusic(songId);
                        });
                    },
                    error: function(xhr, status, error) {
                        showLoading(false, 'searchLoading');
                        showToast('搜索失败，请稍后重试：' + error, 'error');
                    }
                });
            }
            
            // =============================
            // 解析功能实现
            // =============================
            
            // 解析按钮点击事件
            $('#parseBtn').click(function() {
                let input = $('#parseInput').val().trim();
                if (!input) {
                    showToast('请输入歌曲ID或分享链接', 'error');
                    return;
                }
                
                parseMusic(input);
            });
            
            // 解析框回车事件
            $('#parseInput').keypress(function(e) {
                if (e.which === 13) {
                    $('#parseBtn').click();
                }
            });
            
            // 解析音乐函数
            function parseMusic(input) {
                showLoading(true, 'loadingOverlay');
                
                // 提取歌曲ID（可能是纯ID或分享链接）
                let songId = extractSongId(input);
                if (!songId) {
                    showLoading(false, 'loadingOverlay');
                    showToast('无法识别的歌曲ID或链接', 'error');
                    return;
                }
                
                $.ajax({
                    url: 'https://api.kxzjoker.cn/api/163_music',
                    type: 'GET',
                    data: {
                        url: songId,
                        level: selectedQuality,
                        type: 'json'
                    },
                    dataType: 'json',
                    success: function(data) {
                        showLoading(false, 'loadingOverlay');
                        
                        if (!data || data.status !== 200) {
                            let errorMsg = data.msg || '歌曲解析失败，请重试';
                            showToast(errorMsg, 'error');
                            return;
                        }
                        
                        // 显示解析结果
                        displayMusicInfo(data);
                    },
                    error: function(xhr, status, error) {
                        showLoading(false, 'loadingOverlay');
                        showToast('解析失败，请稍后重试：' + error, 'error');
                    }
                });
            }
            
            // 提取歌曲ID函数
            function extractSongId(input) {
                // 如果是纯数字，直接返回
                if (/^\d+$/.test(input)) {
                    return input;
                }
                
                // 尝试从网易云链接中提取ID
                let match = input.match(/(?:id=|song\/)(\d+)/);
                if (match && match[1]) {
                    return match[1];
                }
                
                return null;
            }
            
            // 显示音乐信息
            function displayMusicInfo(song) {
                // 更新DOM元素
                $('#albumCover').attr('src', song.pic);
                $('#songName').text(song.name);
                
                // 处理歌手信息（可能是字符串或数组）
                $('#artistName').text(typeof song.ar_name === 'string' ? 
                    song.ar_name : 
                    song.ar_name.join(', '));
                
                $('#albumName').text(song.al_name);
                $('#qualityDisplay').text(getQualityText(selectedQuality));
                $('#fileSize').text(song.size);
                
                // 处理时长显示 - 只在有数据时显示
                if (song.duration && song.duration > 0) {
                    $('#songDuration').text(formatDuration(song.duration));
                    $('#durationItem').show();
                } else {
                    $('#durationItem').hide();
                }
                
                // 设置下载链接
                $('#downloadBtn').attr('href', song.url);
                
                // 处理歌词
                processLyrics(song.lyric, song.tlyric);
                
                // 初始化播放器
                initPlayer(song);
                
                // 显示结果区域
                $('#parseResultArea').show();
                showToast('解析成功！现在可以播放或下载', 'success');
            }
            
            // 初始化播放器
            function initPlayer(song) {
                // 销毁旧播放器实例
                if (ap) {
                    ap.destroy();
                }
                
                // 创建新播放器
                ap = new APlayer({
                    container: document.getElementById('aplayer'),
                    fixed: true,
                    audio: [{
                        name: song.name,
                        artist: typeof song.ar_name === 'string' ? 
                            song.ar_name : 
                            song.ar_name.join(', '),
                        url: song.url,
                        cover: song.pic,
                        lrc: formatLyrics(song.lyric, song.tlyric)
                    }]
                });
                
                // 监听播放事件，实现歌词滚动效果
                ap.on('play', function() {
                    startLyricScroll();
                });
            }
            
            // 处理歌词函数
            function processLyrics(lyric, tlyric) {
                // 清空歌词容器
                $('#lyricsContainer').empty();
                
                if (!lyric && !tlyric) {
                    $('#lyricsContainer').html('<p class="text-center text-muted">暂无歌词</p>');
                    return;
                }
                
                try {
                    // 解析歌词为带时间戳的对象数组
                    const parsedLyrics = parseLyrics(lyric);
                    const parsedTranslations = parseLyrics(tlyric);
                    
                    // 合并歌词和翻译
                    const merged = mergeLyrics(parsedLyrics, parsedTranslations);
                    
                    // 生成带时间戳的歌词行
                    let lyricsHTML = '';
                    merged.forEach(item => {
                        const translationHtml = item.translation ? 
                            `<br><small class="text-muted">${item.translation}</small>` : '';
                        
                        lyricsHTML += `
                            <p class="lyric-line" data-time="${item.time}">
                                ${item.text}${translationHtml}
                            </p>
                        `;
                    });
                    
                    $('#lyricsContainer').html(lyricsHTML || '<p class="text-center text-muted">歌词加载失败</p>');
                } catch (e) {
                    console.error('歌词处理错误:', e);
                    $('#lyricsContainer').html('<p class="text-center text-muted">歌词处理出错，请重试</p>');
                }
            }
            
            // 解析歌词为结构化数据 - 优化版
            function parseLyrics(lyricStr) {
                if (!lyricStr) return [];
                
                const lines = lyricStr.split('\n');
                const result = [];
                
                lines.forEach(line => {
                    try {
                        // 支持多种时间格式: [mm:ss.xx] 或 [mm:ss:xx] 或 [mm:ss]
                        const match = line.match(/^\[(\d+):(\d+)[\.:]?(\d*)\](.*)$/);
                        if (match) {
                            const min = parseInt(match[1]);
                            const sec = parseInt(match[2]);
                            const ms = match[3] ? parseInt(match[3].padEnd(2, '0').substring(0, 2)) : 0;
                            const text = match[4].trim();
                            
                            // 计算总毫秒数
                            const time = (min * 60 + sec) * 1000 + ms * 10;
                            if (text) {
                                result.push({ 
                                    time: time,
                                    text: text
                                });
                            }
                        }
                    } catch (e) {
                        console.warn('解析歌词行失败:', line, e);
                    }
                });
                
                // 按时间排序
                return result.sort((a, b) => a.time - b.time);
            }
            
            // 合并歌词和翻译 - 优化版
            function mergeLyrics(lyrics, translations) {
                const mergedMap = new Map();
                
                // 添加原歌词
                lyrics.forEach(item => {
                    mergedMap.set(item.time, {
                        time: item.time,
                        text: item.text,
                        translation: ''
                    });
                });
                
                // 添加翻译
                if (translations && translations.length > 0) {
                    translations.forEach(item => {
                        if (mergedMap.has(item.time)) {
                            mergedMap.get(item.time).translation = item.text;
                        } else {
                            mergedMap.set(item.time, {
                                time: item.time,
                                text: '',
                                translation: item.text
                            });
                        }
                    });
                }
                
                // 排序并返回
                return Array.from(mergedMap.values()).sort((a, b) => a.time - b.time);
            }
            
            // 格式化歌词用于播放器 - 优化版
            function formatLyrics(lyric, tlyric) {
                if (!lyric) return '';
                
                const parsedLyrics = parseLyrics(lyric);
                const parsedTranslations = parseLyrics(tlyric);
                const merged = mergeLyrics(parsedLyrics, parsedTranslations);
                
                let formatted = '';
                merged.forEach(item => {
                    const minutes = Math.floor(item.time / 60000);
                    const seconds = Math.floor((item.time % 60000) / 1000);
                    const milliseconds = Math.floor((item.time % 1000) / 10);
                    
                    formatted += `[${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}]${item.text}\n`;
                });
                
                return formatted;
            }
            
            // 歌词滚动效果 - 优化版
            function startLyricScroll() {
                const lyricsContainer = document.getElementById('lyricsContainer');
                const lyricLines = lyricsContainer.querySelectorAll('.lyric-line');
                if (lyricLines.length === 0) return;
                
                let lastActiveLine = -1;
                
                ap.on('timeupdate', function() {
                    const currentTime = ap.audio.currentTime * 1000; // 转为毫秒
                    let currentLine = -1;
                    
                    // 找到当前应该高亮的歌词行
                    for (let i = 0; i < lyricLines.length; i++) {
                        const lineTime = parseInt(lyricLines[i].getAttribute('data-time'));
                        
                        if (lineTime <= currentTime) {
                            currentLine = i;
                        } else {
                            break;
                        }
                    }
                    
                    // 避免重复操作
                    if (currentLine === lastActiveLine) return;
                    lastActiveLine = currentLine;
                    
                    // 更新高亮
                    lyricLines.forEach((line, index) => {
                        if (index === currentLine) {
                            line.classList.add('active');
                            
                            // 滚动到当前行
                            const containerHeight = lyricsContainer.clientHeight;
                            const lineTop = line.offsetTop;
                            const lineHeight = line.clientHeight;
                            
                            lyricsContainer.scrollTo({
                                top: lineTop - containerHeight/2 + lineHeight/2,
                                behavior: 'smooth'
                            });
                        } else {
                            line.classList.remove('active');
                        }
                    });
                });
            }
            
            // =============================
            // 辅助函数
            // =============================
            
            // 格式化时长
            function formatDuration(millis) {
                if (!millis) return '0:00';
                
                let totalSeconds = Math.floor(millis / 1000);
                let minutes = Math.floor(totalSeconds / 60);
                let seconds = totalSeconds % 60;
                
                return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            }
            
            // 获取音质文本
            function getQualityText(value) {
                switch(value) {
                    case 'standard': return '标准音质';
                    case 'exhigh': return '极高音质';
                    case 'lossless': return '无损音质';
                    case 'hires': return 'Hi-Res音质';
                    case 'jyeffect': return '高清环绕声';
                    case 'sky': return '沉浸环绕声';
                    case 'jymaster': return '超清母带';
                    default: return '未知音质';
                }
            }
            
            // 显示加载动画
            function showLoading(show, elementId = 'loadingOverlay') {
                if (show) {
                    $('#' + elementId).show();
                } else {
                    $('#' + elementId).hide();
                }
            }
            
            // 显示Toast通知
            function showToast(message, type = '') {
                let toast = $('#toast');
                toast.text(message);
                
                // 设置类型相关样式
                toast.removeClass('success error');
                if (type) {
                    toast.addClass(type);
                }
                
                // 显示
                toast.addClass('show');
                
                // 5秒后自动隐藏
                setTimeout(() => {
                    toast.removeClass('show');
                }, 5000);
            }
        });
    </script>
</body>
</html>
