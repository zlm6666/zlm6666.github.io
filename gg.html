<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>吐槽</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --md-primary: #6750A4;
            --md-on-primary: #FFFFFF;
            --md-primary-container: #EADDFF;
            --md-on-primary-container: #21005D;
            --md-secondary: #625B71;
            --md-on-secondary: #FFFFFF;
            --md-secondary-container: #E8DEF8;
            --md-on-secondary-container: #1D192B;
            --md-background: #FEF7FF;
            --md-on-background: #1D1B20;
            --md-surface: #FEF7FF;
            --md-on-surface: #1D1B20;
            --md-surface-variant: #E7E0EC;
            --md-on-surface-variant: #49454F;
            --md-error: #B3261E;
            --md-on-error: #FFFFFF;
            --md-shadow: rgba(0, 0, 0, 0.2);
            
            --font-size-base: 1rem;
            --header-height: 64px;
            --controls-height: 72px;
            --border-radius: 16px;
        }

        .dark-mode {
            --md-primary: #D0BCFF;
            --md-on-primary: #371E73;
            --md-primary-container: #4F378B;
            --md-on-primary-container: #EADDFF;
            --md-secondary: #CCC2DC;
            --md-on-secondary: #332D41;
            --md-secondary-container: #4A4458;
            --md-on-secondary-container: #E8DEF8;
            --md-background: #141218;
            --md-on-background: #E6E0E9;
            --md-surface: #141218;
            --md-on-surface: #E6E0E9;
            --md-surface-variant: #49454F;
            --md-on-surface-variant: #CAC4D0;
            --md-error: #F2B8B5;
            --md-on-error: #601410;
            --md-shadow: rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-background);
            color: var(--md-on-background);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        /* 顶部应用栏 - MD3风格 */
        .md-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background-color: var(--md-primary);
            color: var(--md-on-primary);
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: 0 2px 6px var(--md-shadow);
            transition: transform 0.3s ease;
        }

        .md-header.hidden {
            transform: translateY(-100%);
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        /* MD3风格按钮 */
        .md-button {
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-on-primary);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .md-button:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        /* 内容区域 */
        .content-container {
            flex: 1;
            padding: calc(var(--header-height) + 24px) 24px calc(var(--controls-height) + 24px);
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        #content {
            font-size: var(--font-size-base);
            text-align: justify;
            overflow-wrap: break-word;
        }

        #content p {
            margin-bottom: 1.5em;
            text-indent: 2em;
        }

        #content h2, #content h3 {
            margin: 1.8em 0 1em;
            color: var(--md-primary);
            font-weight: 500;
        }

        #content h2 {
            font-size: 1.5rem;
            border-bottom: 1px solid var(--md-surface-variant);
            padding-bottom: 0.5em;
        }

        #content h3 {
            font-size: 1.25rem;
        }

        #content blockquote {
            border-left: 4px solid var(--md-primary);
            padding: 0.8em 1.2em;
            margin: 1.8em 0;
            background-color: var(--md-primary-container);
            color: var(--md-on-primary-container);
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        /* 自定义语法样式 */
        .custom-bold { font-weight: 700; }
        .custom-italic { font-style: italic; }
        .custom-strike { text-decoration: line-through; }
        .custom-underline { text-decoration: underline; }
        .custom-color { color: inherit; }
        
        .custom-url {
            color: #1976d2;
            text-decoration: underline;
            font-weight: 500;
        }

        /* 底部控制栏 - MD3风格 */
        .md-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--controls-height);
            background-color: var(--md-surface);
            color: var(--md-on-surface);
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: 0 -2px 6px var(--md-shadow);
            transition: transform 0.3s ease;
        }

        .md-controls.hidden {
            transform: translateY(100%);
        }

        .control-group {
            display: flex;
            gap: 8px;
        }

        /* 字体大小控制 */
        .font-size-controls {
            display: flex;
            align-items: center;
            background-color: var(--md-surface-variant);
            border-radius: 20px;
            padding: 4px;
        }

        .font-size-btn {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--md-on-surface-variant);
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .font-size-btn.active {
            background-color: var(--md-primary);
            color: var(--md-on-primary);
        }

        /* 加载状态 */
        .loading {
            padding: 40px;
            text-align: center;
            color: var(--md-on-surface-variant);
        }

        .loading-spinner {
            display: inline-block;
            width: 48px;
            height: 48px;
            border: 3px solid var(--md-primary-container);
            border-radius: 50%;
            border-top-color: var(--md-primary);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 错误提示 */
        .error-message {
            padding: 24px;
            text-align: center;
            color: var(--md-error);
            background-color: rgba(179, 38, 30, 0.08);
            border-radius: var(--border-radius);
            margin: 20px 0;
        }

        /* 响应式设计 */
        @media (max-width: 600px) {
            :root {
                --header-height: 56px;
                --controls-height: 64px;
            }
            
            .content-container {
                padding: calc(var(--header-height) + 16px) 16px calc(var(--controls-height) + 16px);
            }
            
            .header-title {
                font-size: 1.1rem;
            }
            
            #content {
                font-size: calc(var(--font-size-base) - 0.05rem);
            }
            
            .control-group {
                gap: 4px;
            }
        }

        /* 阅读进度指示器 */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background-color: var(--md-primary);
            z-index: 1001;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- 阅读进度条 -->
    <div class="progress-bar"></div>

    <!-- 顶部应用栏 -->
    <div class="md-header">
        <div class="header-title">
            <i class="fas fa-book-open"></i>
            <span>MD3阅读器</span>
        </div>
        <div class="header-actions">
            <button id="modeToggle" class="md-button">
                <i class="fas fa-moon"></i>
            </button>
            <button id="fontSizeMenu" class="md-button">
                <i class="fas fa-text-height"></i>
            </button>
        </div>
    </div>

    <!-- 内容区域 -->
    <div class="content-container">
        <div id="content">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>正在加载内容...</p>
            </div>
        </div>
    </div>

    <!-- 底部控制栏 -->
    <div class="md-controls">
        <div class="control-group">
            <button id="fontDecrease" class="md-button">
                <i class="fas fa-minus"></i>
            </button>
            
            <div class="font-size-controls">
                <button class="font-size-btn" data-size="small">A</button>
                <button class="font-size-btn active" data-size="medium">A</button>
                <button class="font-size-btn" data-size="large">A</button>
            </div>
            
            <button id="fontIncrease" class="md-button">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        
        <div class="control-group">
            <button id="nightModeToggle" class="md-button">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>

    <script>
        // 文本内容加载函数
        async function loadExternalContent() {
            try {
                const response = await fetch('./mtp/txt/gg.txt');
                if (!response.ok) throw new Error('网络响应不正常');
                const text = await response.text();
                return text;
            } catch (error) {
                showError('内容加载失败，请检查文件路径或网络连接');
                return '';
            }
        }

        // 自定义语法解析函数
        const regexMap = {
            bold: /\[b\](.*?)\[\/b\]/g,
            italic: /\[i\](.*?)\[\/i\]/g,
            strike: /\[s\](.*?)\[\/s\]/g,
            underline: /\[u\](.*?)\[\/u\]/g,
            color: /\[color=(red|blue|green|yellow|pink)\](.*?)\[\/color\]/gi,
            url: /\[url(?:=(https?:\/\/[^ ]+))?\](.*?)\[\/url\]/gi
        };

        function parseCustomSyntax(text) {
            // 处理超链接
            text = text.replace(regexMap.url, (match, protocol, content) => {
                const url = protocol || `//${content}`; // 自动补全协议
                return `<a href="${url}" target="_blank" class="custom-url">${content}</a>`;
            });

            // 处理其他语法
            text = text.replace(regexMap.bold, '<span class="custom-bold">$1</span>');
            text = text.replace(regexMap.italic, '<span class="custom-italic">$1</span>');
            text = text.replace(regexMap.strike, '<span class="custom-strike">$1</span>');
            text = text.replace(regexMap.underline, '<span class="custom-underline">$1</span>');
            text = text.replace(regexMap.color, (match, color, content) => {
                return `<span class="custom-color" style="color:${color}">${content}</span>`;
            });

            // 转换Markdown标题
            text = text.replace(/^# (.*)$/gm, '<h2>$1</h2>')
                       .replace(/^## (.*)$/gm, '<h3>$1</h3>');

            // 转换Markdown引用
            text = text.replace(/^> (.*)$/gm, '<blockquote>$1</blockquote>');

            // 处理段落
            const paragraphs = text.split(/\n\s*\n/);
            return paragraphs.map(p => {
                const trimmed = p.trim();
                return trimmed ? `<p>${trimmed}</p>` : '';
            }).join('');
        }

        // 错误提示函数
        function showError(message) {
            const errorContainer = document.createElement('div');
            errorContainer.className = 'error-message';
            errorContainer.textContent = message;
            document.body.appendChild(errorContainer);
        }

        // 主题切换函数
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            
            const modeIcon = document.body.classList.contains('dark-mode') ? 'sun' : 'moon';
            document.getElementById('modeToggle').innerHTML = `<i class="fas fa-${modeIcon}"></i>`;
            document.getElementById('nightModeToggle').innerHTML = `<i class="fas fa-${modeIcon}"></i>`;
            
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        // 字体大小控制
        function setFontSize(size) {
            document.documentElement.style.setProperty('--font-size-base', 
                size === 'small' ? '0.9rem' : 
                size === 'medium' ? '1rem' : 
                '1.1rem'
            );
            
            document.querySelectorAll('.font-size-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.size === size);
            });
            
            localStorage.setItem('fontSize', size);
        }

        // 滚动控制
        let lastScrollTop = 0;
        let controlsVisible = true;

        function handleScroll() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            // 更新进度条
            const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
            const scrollPercent = Math.min(scrollTop / scrollHeight * 100, 100);
            document.querySelector('.progress-bar').style.width = `${scrollPercent}%`;
            
            // 控制栏显示逻辑
            if (scrollTop > lastScrollTop && scrollTop > 100) {
                if (controlsVisible) {
                    document.querySelector('.md-header').classList.add('hidden');
                    document.querySelector('.md-controls').classList.add('hidden');
                    controlsVisible = false;
                }
            } else {
                if (!controlsVisible) {
                    document.querySelector('.md-header').classList.remove('hidden');
                    document.querySelector('.md-controls').classList.remove('hidden');
                    controlsVisible = true;
                }
            }
            
            lastScrollTop = scrollTop;
        }

        // 初始化函数
        async function initApp() {
            // 加载用户配置
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) toggleDarkMode();
            
            const fontSize = localStorage.getItem('fontSize') || 'medium';
            setFontSize(fontSize);
            
            // 加载外部内容
            const contentElement = document.getElementById('content');
            contentElement.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>正在加载内容...</p></div>';
            
            try {
                const text = await loadExternalContent();
                if (!text) return;
                
                const formattedText = parseCustomSyntax(text);
                contentElement.innerHTML = formattedText;
            } catch (error) {
                showError('内容加载失败：' + error.message);
            }
            
            // 添加事件监听
            document.getElementById('modeToggle').addEventListener('click', toggleDarkMode);
            document.getElementById('fontSizeMenu').addEventListener('click', () => {
                document.querySelector('.font-size-controls').classList.toggle('active');
            });
            
            document.querySelectorAll('.font-size-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    setFontSize(btn.dataset.size);
                    document.querySelector('.font-size-controls').classList.remove('active');
                });
            });
            
            document.getElementById('fontDecrease').addEventListener('click', () => {
                const sizes = ['small', 'medium', 'large'];
                const index = sizes.indexOf(localStorage.getItem('fontSize') || 'medium');
                setFontSize(sizes[(index - 1 + sizes.length) % sizes.length]);
            });
            
            document.getElementById('fontIncrease').addEventListener('click', () => {
                const sizes = ['small', 'medium', 'large'];
                const index = sizes.indexOf(localStorage.getItem('fontSize') || 'medium');
                setFontSize(sizes[(index + 1) % sizes.length]);
            });
            
            window.addEventListener('scroll', handleScroll);
            window.addEventListener('resize', handleScroll);
            document.getElementById('content').addEventListener('click', () => {
                if (controlsVisible) {
                    document.querySelector('.md-header').classList.add('hidden');
                    document.querySelector('.md-controls').classList.add('hidden');
                    controlsVisible = false;
                } else {
                    document.querySelector('.md-header').classList.remove('hidden');
                    document.querySelector('.md-controls').classList.remove('hidden');
                    controlsVisible = true;
                }
            });
        }

        // 等待DOM加载完成
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });
    </script>
</body>
</html>